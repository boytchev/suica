// Suica 2.0

document.write('<script src="three.min.js" onload="LoadSuica();"></script>');﻿function LoadSuica(){﻿
console.log(`Suica 2.-1.24 (220219)`);const DEBUG_CALLS=!false;class Suica
{static current;static allSuicas=[];static OX=new THREE.Vector3(1,0,0);static OY=new THREE.Vector3(0,1,0);static OZ=new THREE.Vector3(0,0,1);static ORIENTATIONS={YXZ:{SCALE:new THREE.Vector3(1,-1,1),UP:Suica.OX,FLIP_NORMAL:true,MATRIX:new THREE.Matrix4().makeBasis(Suica.OY,Suica.OX,Suica.OZ)},ZYX:{SCALE:new THREE.Vector3(1,1,-1),UP:Suica.OY,FLIP_NORMAL:true,MATRIX:new THREE.Matrix4().makeBasis(Suica.OZ,Suica.OY,Suica.OX)},XZY:{SCALE:new THREE.Vector3(-1,1,1),UP:Suica.OZ,FLIP_NORMAL:true,MATRIX:new THREE.Matrix4().makeBasis(Suica.OX,Suica.OZ,Suica.OY)},ZXY:{SCALE:new THREE.Vector3(1,1,1),UP:Suica.OX,FLIP_NORMAL:false,MATRIX:new THREE.Matrix4().makeBasis(Suica.OZ,Suica.OX,Suica.OY)},XYZ:{SCALE:new THREE.Vector3(1,1,1),UP:Suica.OY,FLIP_NORMAL:false,MATRIX:new THREE.Matrix4().makeBasis(Suica.OX,Suica.OY,Suica.OZ)},YZX:{SCALE:new THREE.Vector3(1,1,1),UP:Suica.OZ,FLIP_NORMAL:false,MATRIX:new THREE.Matrix4().makeBasis(Suica.OY,Suica.OZ,Suica.OX)},}
flipNormal(geometry)
{if(this.orientation.FLIP_NORMAL)
{var nor=geometry.getAttribute('normal').array;for(var i=0;i<nor.length;i++)
nor[i]=-nor[i];}
return geometry;}
static DEFAULT={VR:{},ANAGLYPH:{DISTANCE:5},STEREO:{DISTANCE:1},PERSPECTIVE:{NEAR:1,FAR:1000,FOV:40},ORTHOGRAPHIC:{NEAR:0,FAR:1000},BACKGROUND:{COLOR:'whitesmoke'},ORIENTATION:'XYZ',SIZE:'30',OXYZ:{COLOR:'black',SIZE:30},DEMO:{DISTANCE:100,ALTITUDE:30},ONTIME:{SRC:null},POINT:{CENTER:[0,0,0],COLOR:'crimson',SIZE:7},LINE:{CENTER:[0,0,0],COLOR:'black',TO:[0,30,0]},CUBE:{CENTER:[0,0,0],COLOR:'cornflowerblue',FRAMECOLOR:'black',SIZE:30},SQUARE:{CENTER:[0,0,0],COLOR:'cornflowerblue',FRAMECOLOR:'black',SIZE:30},CIRCLE:{CENTER:[0,0,0],COLOR:'cornflowerblue',FRAMECOLOR:'black',SIZE:30,COUNT:50},POLYGON:{CENTER:[0,0,0],COLOR:'cornflowerblue',FRAMECOLOR:'black',SIZE:30,COUNT:3},SPHERE:{CENTER:[0,0,0],COLOR:'cornflowerblue',SIZE:30,COUNT:50},CYLINDER:{CENTER:[0,0,0],COLOR:'cornflowerblue',SIZE:30,COUNT:50,RATIO:1},CONE:{CENTER:[0,0,0],COLOR:'cornflowerblue',SIZE:30,COUNT:50,RATIO:0},PRISM:{CENTER:[0,0,0],COLOR:'cornflowerblue',SIZE:30,COUNT:6,RATIO:1},PYRAMID:{CENTER:[0,0,0],COLOR:'cornflowerblue',SIZE:30,COUNT:6,RATIO:0},}
constructor(suicaTag)
{this._={solidGeometry:{},frameGeometry:{},};suicaTag.style.display='inline-block';suicaTag.style.boxSizing='border-box';if(!suicaTag.style.position)suicaTag.style.position='relative';this.id=suicaTag.getAttribute('id')||`suica${Suica.allSuicas.length}`
if(DEBUG_CALLS)console.log(`Suica :: ${this.id}`);this.suicaTag=suicaTag;this.orientation=Suica.ORIENTATIONS[suicaTag.getAttribute('ORIENTATION')?.toUpperCase()||Suica.DEFAULT.ORIENTATION];this.createCanvas();this.createRenderer();this.parser=new HTMLParser(this);this.onTimeHandler=null;this.demoViewPoint=null;Suica.current=this;Suica.allSuicas.push(this);window[this.id]=this;}
createCanvas()
{if(this.suicaTag.clientWidth<1)
this.suicaTag.style.width=(this.suicaTag.getAttribute('width')||500)+'px';if(this.suicaTag.clientHeight<1)
this.suicaTag.style.height=(this.suicaTag.getAttribute('height')||300)+'px';this.canvas=document.createElement('canvas');this.canvas.width=this.suicaTag.clientWidth;this.canvas.height=this.suicaTag.clientHeight;this.canvas.style=` border: solid 1px gray;
        width: 100%;
        height: 100%;
        box-sizing: border-box;`;this.suicaTag.appendChild(this.canvas);}
get canvasAspect()
{return this.canvas.width/this.canvas.height;}
render()
{if(this.uberRenderer)
this.uberRenderer.render(this.scene,this.camera);else
this.renderer.render(this.scene,this.camera);}
createRenderer()
{this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,alpha:true,antialias:true});this.uberRenderer=null;this.scene=new THREE.Scene();this.scene.scale.copy(this.orientation.SCALE);var color=getComputedStyle(this.suicaTag).backgroundColor;if(color=='rgba(0, 0, 0, 0)')
{color=this.suicaTag.getAttribute('background')||Suica.DEFAULT.BACKGROUND.COLOR;}
this.scene.background=Suica.parseColor(color);if(this.suicaTag.hasAttribute('PERSPECTIVE'))
{let values=this.suicaTag.getAttribute('PERSPECTIVE').replaceAll(' ','');values=values?values.split(',').map(Number):[];this.perspective(...values);}
else
if(this.suicaTag.hasAttribute('ORTHOGRAPHIC'))
{let values=this.suicaTag.getAttribute('ORTHOGRAPHIC').replaceAll(' ','');values=values?values.split(',').map(Number):[];this.orthographic(...values);}
else
{this.perspective();}
if(this.suicaTag.hasAttribute('ANAGLYPH'))
{let values=this.suicaTag.getAttribute('ANAGLYPH').replaceAll(' ','');values=values?values.split(',').map(Number):[];this.anaglyph(...values);}
else
if(this.suicaTag.hasAttribute('STEREO'))
{let values=this.suicaTag.getAttribute('STEREO').replaceAll(' ','');values=values?values.split(',').map(Number):[];this.stereo(...values);}
if(this.suicaTag.hasAttribute('VR'))
{let values=this.suicaTag.getAttribute('VR').replaceAll(' ','');values=values?values.split(',').map(Number):[];this.vr(...values);}
this.light=new THREE.PointLight('white',0.5);this.light.position.set(1000,1500,3000);this.scene.add(this.light);this.scene.add(new THREE.AmbientLight('white',0.5));var that=this;this.lastTime=0;function loop(time)
{time/=1000;if(that.demoViewPoint)
{var x=that.demoViewPoint.distance*Math.cos(time),y=that.demoViewPoint.altitude,z=that.demoViewPoint.distance*Math.sin(time);switch(that.orientation)
{case Suica.ORIENTATIONS.XYZ:that.camera.position.set(x,y,-z);that.light.position.set(2*x,2*y,-2*z);break;case Suica.ORIENTATIONS.XZY:that.camera.position.set(-x,-z,y);that.light.position.set(2*x,-2*z,2*y);break;case Suica.ORIENTATIONS.YXZ:that.camera.position.set(y,-x,-z);that.light.position.set(2*y,2*x,-2*z);break;case Suica.ORIENTATIONS.YZX:that.camera.position.set(-z,x,y);that.light.position.set(-2*z,2*x,2*y);break;case Suica.ORIENTATIONS.ZXY:that.camera.position.set(y,-z,x);that.light.position.set(2*y,-2*z,2*x);break;case Suica.ORIENTATIONS.ZYX:that.camera.position.set(-z,y,-x);that.light.position.set(-2*z,2*y,2*x);break;default:console.error('error: Unknown orientation in <suica>');};that.camera.lookAt(that.scene.position);}
if(that.onTimeHandler)
{if(typeof that.onTimeHandler==='string'||that.onTimeHandler instanceof String)
that.onTimeHandler=window[that.onTimeHandler];that.onTimeHandler(time,time-that.lastTime);}
that.render();that.lastTime=time;}
this.renderer.setAnimationLoop(loop);}
vr()
{this.parser?.parseTags();this.debugCall('vr');this.suicaTag.appendChild(VRButton.createButton(this.renderer));this.renderer.xr.enabled=true;this.camera.position.set(0,0,0);}
anaglyph(distance=Suica.DEFAULT.ANAGLYPH.DISTANCE)
{this.parser?.parseTags();this.debugCall('anaglyph',distance);this.uberRenderer?.dispose();this.uberRenderer=new AnaglyphEffect(this,distance);}
stereo(distance=Suica.DEFAULT.STEREO.DISTANCE)
{this.parser?.parseTags();this.debugCall('stereo',distance);this.uberRenderer?.dispose();this.uberRenderer=new StereoEffect(this,distance);}
perspective(near=Suica.DEFAULT.PERSPECTIVE.NEAR,far=Suica.DEFAULT.PERSPECTIVE.FAR,fov=Suica.DEFAULT.PERSPECTIVE.FOV)
{this.parser?.parseTags();this.debugCall('perspective',near,far,fov);this.camera=new THREE.PerspectiveCamera(fov,this.canvasAspect,near,far);this.camera.up.copy(this.orientation.UP);this.camera.position.set(0,0,100);this.camera.lookAt(this.scene.position);this.camera.updateProjectionMatrix();}
orthographic(near=Suica.DEFAULT.ORTHOGRAPHIC.NEAR,far=Suica.DEFAULT.ORTHOGRAPHIC.FAR)
{this.parser?.parseTags();this.debugCall('orthographic',near,far);var w=this.canvas.width/2,h=this.canvas.height/2;this.camera=new THREE.OrthographicCamera(-w,w,h,-h,near,far);this.camera.up.copy(this.orientation.UP);this.camera.position.set(0,0,100);this.camera.lookAt(this.scene.position);this.camera.updateProjectionMatrix();}
background(color=Suica.DEFAULT.BACKGROUND.COLOR)
{this.parser?.parseTags();this.debugCall('background',color);this.scene.background=new THREE.Color(color);}
oxyz(size=Suica.DEFAULT.OXYZ.SIZE,color=Suica.DEFAULT.OXYZ.COLOR)
{this.parser?.parseTags();this.debugCall('oxyz',size,color);var axes=new THREE.AxesHelper(size)
axes.setColors(color,color,color);this.scene.add(axes);}
demo(distance=Suica.DEFAULT.DEMO.DISTANCE,altitude=Suica.DEFAULT.DEMO.ALTITUDE)
{this.parser?.parseTags();this.debugCall('demo',distance,altitude);this.demoViewPoint={distance:distance,altitude:altitude};}
onTime(src=Suica.DEFAULT.ONTIME.SRC)
{this.parser?.parseTags();this.debugCall('onTime',src);this.onTimeHandler=src;}
static precheck()
{if(!(Suica.current instanceof Suica))
throw'error: No Suica instance is active';}
debugCall(functionName,...parameters)
{if(!DEBUG_CALLS)return;for(var i=0;i<parameters.length;i++)
{if(Array.isArray(parameters[i]))
parameters[i]=`[${parameters[i]}]`;else
if(typeof parameters[i]==='string'||parameters[i]instanceof String)
parameters[i]=`'${parameters[i]}'`;else
parameters[i]=''+parameters[i];}
console.info(`:: ${this.id}.${functionName}(${parameters.join(',')})`);}
static parseColor(color)
{if(color instanceof THREE.Color)
return color;if(Array.isArray(color))
return new THREE.Color(color[0],color[1]||0,color[2]||0);if(typeof color==='string'||color instanceof String)
{color=color.toLowerCase().replaceAll(' ','');if(color[0]=='0'&&color[1]=='x')
return new THREE.Color(Number(color));if(color[0]=='r'&&color[1]=='g'&&color[2]=='b')
return new THREE.Color(color);if(color[0]=='h'&&color[1]=='s'&&color[2]=='l')
{color=color.substring(4).split(',');return hsl(parseFloat(color[0]),parseFloat(color[1]),parseFloat(color[2]));}
if(color.indexOf(',')>0)
{color=color.split(',');return new THREE.Color(Number(color[0]),Number(color[1]),Number(color[2]));}}
return new THREE.Color(color||'white');}
static parseCenter(center)
{if(center.center)
return center.center;if(Array.isArray(center))
return center;if(typeof center==='string'||center instanceof String)
{center=center.replaceAll(' ','');if(center.indexOf(',')>0)
{center=center.split(',').map(Number);return[Number(center[0]),Number(center[1]),Number(center[2])];}
if(window[center]&&window[center].center)
{return window[center].center;}}
return center;}
static parseSize(size)
{if(typeof size==='string'||size instanceof String)
{size=size.replaceAll(' ','');if(size.indexOf(',')>0)
{return size.split(',').map(Number);}}
return size;}
static parseRadius(radius)
{if(typeof radius==='string'||radius instanceof String)
{radius=radius.replaceAll(' ','');if(radius.indexOf(',')>0)
{return radius.split(',').map(Number);}}
return radius;}
static parseColorTest()
{function test(color)
{var parsedColor=Suica.parseColor(color);if(parsedColor.r==1&&parsedColor.g==0&&parsedColor.b==0)
return null;return color;}
var testValues=['red','Red','RED',0xFF0000,0XFF0000,'0XFF0000','0xFF0000','0xff0000','0Xff0000',[1,0,0],'1,0,0','1, 0, 0','rgb(255,0,0)','rgb( 255, 0, 0)',' rgb ( 255 , 0 , 0 ) ','RGB( 255, 0, 0 )',rgb(255,0,0),'hsl(0,100,50)','hsl( 0, 100, 50 )',' hsl ( 0 , 100 , 50 ) ','HSL( 0, 100, 50 )',hsl(0,100,50),new THREE.Color('red')]
var summary=[];for(var value of testValues)
{var result=test(value);if(result)summary.push(result);}
if(summary.length)
console.log(`Suica::parseColorTest() - failed at: \n\t|${summary.join('|\n\t|')}|`);else
console.log(`Suica::parseColorTest() - passed OK`);}
point(center=Suica.DEFAULT.POINT.CENTER,size=Suica.DEFAULT.POINT.SIZE,color=Suica.DEFAULT.POINT.COLOR)
{this.parser?.parseTags();return new Point(this,center,size,color);}
line(center=Suica.DEFAULT.LINE.CENTER,to=Suica.DEFAULT.LINE.TO,color=Suica.DEFAULT.LINE.COLOR)
{this.parser?.parseTags();return new Line(this,center,to,color);}
square(center=Suica.DEFAULT.SQUARE.CENTER,size=Suica.DEFAULT.SQUARE.SIZE,color=Suica.DEFAULT.SQUARE.COLOR)
{this.parser?.parseTags();return new Square(this,center,size,color);}
cube(center=Suica.DEFAULT.CUBE.CENTER,size=Suica.DEFAULT.CUBE.SIZE,color=Suica.DEFAULT.CUBE.COLOR)
{this.parser?.parseTags();return new Cube(this,center,size,color);}
circle(center=Suica.DEFAULT.CIRCLE.CENTER,size=Suica.DEFAULT.CIRCLE.SIZE,color=Suica.DEFAULT.CIRCLE.COLOR)
{this.parser?.parseTags();return new Polygon(this,Suica.DEFAULT.CIRCLE.COUNT,center,size,color);}
polygon(count=Suica.DEFAULT.POLYGON.COUNT,center=Suica.DEFAULT.POLYGON.CENTER,size=Suica.DEFAULT.POLYGON.SIZE,color=Suica.DEFAULT.CIRCLE.COLOR)
{this.parser?.parseTags();return new Polygon(this,count,center,size,color);}
sphere(center=Suica.DEFAULT.SPHERE.CENTER,size=Suica.DEFAULT.SPHERE.SIZE,color=Suica.DEFAULT.SPHERE.COLOR)
{this.parser?.parseTags();return new Sphere(this,center,size,color);}
cylinder(center=Suica.DEFAULT.CYLINDER.CENTER,size=Suica.DEFAULT.CYLINDER.SIZE,color=Suica.DEFAULT.CYLINDER.COLOR)
{this.parser?.parseTags();return new Prism(this,Suica.DEFAULT.CYLINDER.COUNT,center,size,color,false);}
prism(count=Suica.DEFAULT.PRISM.COUNT,center=Suica.DEFAULT.PRISM.CENTER,size=Suica.DEFAULT.PRISM.SIZE,color=Suica.DEFAULT.PRISM.COLOR)
{this.parser?.parseTags();return new Prism(this,count,center,size,color,true);}
cone(center=Suica.DEFAULT.CONE.CENTER,size=Suica.DEFAULT.CONE.SIZE,color=Suica.DEFAULT.CONE.COLOR)
{this.parser?.parseTags();return new Pyramid(this,Suica.DEFAULT.CONE.COUNT,center,size,color,false);}
pyramid(count=Suica.DEFAULT.PYRAMID.COUNT,center=Suica.DEFAULT.PYRAMID.CENTER,size=Suica.DEFAULT.PYRAMID.SIZE,color=Suica.DEFAULT.PYRAMID.COLOR)
{this.parser?.parseTags();return new Pyramid(this,count,center,size,color,true);}}
window.style=function(object,properties)
{for(var n in properties)object[n]=properties[n];}
window.perspective=function(near=Suica.DEFAULT.PERSPECTIVE.NEAR,far=Suica.DEFAULT.PERSPECTIVE.FAR,fov=Suica.DEFAULT.PERSPECTIVE.FOV)
{Suica.precheck();Suica.current.perspective(near,far,fov);}
window.orthographic=function(near=Suica.DEFAULT.ORTHOGRAPHIC.NEAR,far=Suica.DEFAULT.ORTHOGRAPHIC.FAR)
{Suica.precheck();Suica.current.orthographic(near,far);}
window.background=function(color=Suica.DEFAULT.BACKGROUND.COLOR)
{Suica.precheck();Suica.current.background(color);}
window.oxyz=function(size=Suica.DEFAULT.OXYZ.SIZE,color=Suica.DEFAULT.OXYZ.COLOR)
{Suica.precheck();Suica.current.oxyz(size,color);}
window.demo=function(distance=Suica.DEFAULT.DEMO.DISTANCE,altitude=Suica.DEFAULT.DEMO.ALTITUDE)
{Suica.precheck();Suica.current.demo(distance,altitude);}
window.onTime=function(src=Suica.DEFAULT.ONTIME.SRC)
{Suica.precheck();Suica.current.onTime(src);}
window.element=function(id)
{return document.getElementById(id);}
window.rgb=function(r,g,b)
{return new THREE.Color(r/255,g/255,b/255);}
window.hsl=function(h,s,l)
{return new THREE.Color().setHSL(h/360,s/100,l/100);}
window.random=function(a=0,b=1)
{if(Array.isArray(a))
{return a[THREE.Math.randInt(0,a.length-1)];}
return a+(b-a)*Math.random();}
window.radians=function(degrees)
{return degrees*Math.PI/180;}
window.degrees=function(radians)
{return radians*180/Math.PI;}
window.sameAs=function(object)
{if(object.clone)
return object.clone();else
throw'error: cannot clone object';}
new MutationObserver(function(mutations)
{for(var parentElem of mutations)
{for(var childElem of parentElem.addedNodes)
{if(childElem?.tagName=='SCRIPT')
for(var suica of Suica.allSuicas)
suica.parser?.parseTags();if(childElem?.tagName=='SUICA')
new Suica(childElem);}
if(parentElem.type=='attributes'&&parentElem.target.suicaObject)
{var name=parentElem.attributeName,value=parentElem.target.getAttribute(parentElem.attributeName);parentElem.target.suicaObject[name]=value;}}}).observe(document,{childList:true,subtree:true,attributes:true});window.addEventListener('load',function()
{for(var suica of Suica.allSuicas)
suica.parser?.parseTags();});class VRButton{static createButton(renderer,options){if(options){console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');}
const button=document.createElement('button');function showEnterVR(){let currentSession=null;async function onSessionStarted(session){session.addEventListener('end',onSessionEnded);await renderer.xr.setSession(session);button.textContent='EXIT VR';currentSession=session;}
function onSessionEnded(){currentSession.removeEventListener('end',onSessionEnded);button.textContent='ENTER VR';currentSession=null;}
button.style.display='';button.style.cursor='pointer';button.style.left='calc(50% - 50px)';button.style.width='100px';button.textContent='ENTER VR';button.onmouseenter=function(){button.style.opacity='1.0';};button.onmouseleave=function(){button.style.opacity='0.5';};button.onclick=function(){if(currentSession===null){const sessionInit={optionalFeatures:['local-floor','bounded-floor','hand-tracking','layers']};navigator.xr.requestSession('immersive-vr',sessionInit).then(onSessionStarted);}else{currentSession.end();}};}
function disableButton(){button.style.display='';button.style.cursor='auto';button.style.left='calc(50% - 75px)';button.style.width='150px';button.onmouseenter=null;button.onmouseleave=null;button.onclick=null;}
function showWebXRNotFound(){disableButton();button.textContent='VR NOT SUPPORTED';}
function stylizeElement(element){element.style.position='absolute';element.style.bottom='20px';element.style.padding='12px 6px';element.style.border='1px solid #fff';element.style.borderRadius='4px';element.style.background='rgba(0,0,0,0.5)';element.style.color='#fff';element.style.font='normal 13px';element.style.textAlign='center';element.style.opacity='0.5';element.style.outline='none';element.style.zIndex='999';}
if('xr'in navigator){button.id='VRButton';button.style.display='none';stylizeElement(button);navigator.xr.isSessionSupported('immersive-vr').then(function(supported){supported?showEnterVR():showWebXRNotFound();});return button;}else{const message=document.createElement('a');if(window.isSecureContext===false){message.href=document.location.href.replace(/^http:/,'https:');message.innerHTML='WEBXR NEEDS HTTPS';}else{message.href='https://immersiveweb.dev/';message.innerHTML='WEBXR NOT AVAILABLE';}
message.style.left='calc(50% - 90px)';message.style.width='180px';message.style.textDecoration='none';stylizeElement(message);return message;}}}
class AnaglyphEffect
{constructor(suica,distance)
{this.suica=suica;this.suica.camera.focus=distance;this.colorMatrixLeft=new THREE.Matrix3().fromArray([1,0,0,0,0,0,0,0,0,]);this.colorMatrixRight=new THREE.Matrix3().fromArray([0,0,0,0,1,0,0,0,1,]);this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1);this.scene=new THREE.Scene();this.stereo=new THREE.StereoCamera();var params={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat};this.renderTargetL=new THREE.WebGLRenderTarget(this.suica.canvas.width,this.suica.canvas.height,params);this.renderTargetR=new THREE.WebGLRenderTarget(this.suica.canvas.width,this.suica.canvas.height,params);this.material=new THREE.ShaderMaterial({uniforms:{'mapLeft':{value:this.renderTargetL.texture},'mapRight':{value:this.renderTargetR.texture},'colorMatrixLeft':{value:this.colorMatrixLeft},'colorMatrixRight':{value:this.colorMatrixRight}},vertexShader:`
    varying vec2 vUv;
    void main()
    {
     vUv = vec2( uv.x, uv.y );
     gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }`,fragmentShader:`
    uniform sampler2D mapLeft;
    uniform sampler2D mapRight;
    varying vec2 vUv;
    uniform mat3 colorMatrixLeft;
    uniform mat3 colorMatrixRight;
    
    // These functions implement sRGB linearization and gamma correction
    float lin( float c )
    {
     return c<=0.04045 ? c*0.0773993808 : pow( c*0.9478672986+0.0521327014, 2.4 );
    }
    vec4 lin( vec4 c )
    {
     return vec4( lin( c.r ), lin( c.g ), lin( c.b ), c.a );
    }
    float dev( float c )
    {
     return c<=0.0031308 ? c*12.92 : pow( c, 0.41666 ) * 1.055 - 0.055;
    }
    
    void main()
    {
     vec2 uv = vUv;
     vec4 colorL = lin( texture2D( mapLeft, uv ) );
     vec4 colorR = lin( texture2D( mapRight, uv ) );
     vec3 color = clamp( colorMatrixLeft * colorL.rgb + colorMatrixRight * colorR.rgb, 0., 1. );
     gl_FragColor = vec4( dev( color.r ), dev( color.g ), dev( color.b ), max( colorL.a, colorR.a ) );
    }`});this.mesh=new THREE.Mesh(new THREE.PlaneGeometry(2,2),this.material);this.scene.add(this.mesh);}
setSize(width,height)
{this.suica.renderer.setSize(width,height);var pixelRatio=this.suica.renderer.getPixelRatio();this.renderTargetL.setSize(width*pixelRatio,height*pixelRatio);this.renderTargetR.setSize(width*pixelRatio,height*pixelRatio);};render(scene,camera)
{var currentRenderTarget=this.suica.renderer.getRenderTarget();scene.updateMatrixWorld();if(camera.parent===null)camera.updateMatrixWorld();this.stereo.update(camera);this.suica.renderer.setRenderTarget(this.renderTargetL);this.suica.renderer.clear();this.suica.renderer.render(scene,this.stereo.cameraL);this.suica.renderer.setRenderTarget(this.renderTargetR);this.suica.renderer.clear();this.suica.renderer.render(scene,this.stereo.cameraR);this.suica.renderer.setRenderTarget(null);this.suica.renderer.render(this.scene,this.camera);this.suica.renderer.setRenderTarget(currentRenderTarget);};dispose()
{this.renderTargetL.dispose();this.renderTargetR.dispose();this.mesh.geometry.dispose();this.material.dispose();};}
class StereoEffect
{constructor(suica,distance)
{this.suica=suica;this.stereo=new THREE.StereoCamera();this.stereo.aspect=0.5;this.stereo.eyeSep=distance;this.size=new THREE.Vector2();}
setSize(width,height)
{this.suica.renderer.setSize(width,height);}
render(scene,camera)
{scene.updateMatrixWorld();if(camera.parent===null)camera.updateMatrixWorld();this.stereo.update(camera);this.suica.renderer.getSize(this.size);if(this.suica.renderer.autoClear)this.suica.renderer.clear();this.suica.renderer.setScissorTest(true);this.suica.renderer.setScissor(0,0,this.size.width/2,this.size.height);this.suica.renderer.setViewport(0,0,this.size.width/2,this.size.height);this.suica.renderer.render(scene,this.stereo.cameraL);this.suica.renderer.setScissor(this.size.width/2,0,this.size.width/2,this.size.height);this.suica.renderer.setViewport(this.size.width/2,0,this.size.width/2,this.size.height);this.suica.renderer.render(scene,this.stereo.cameraR);this.suica.renderer.setScissorTest(false);};dispose()
{};}
﻿
class HTMLParser
{constructor(suica)
{this.suica=suica;this.parseTag={};this.parseTag.OXYZ=this.parseTagOXYZ;this.parseTag.DEMO=this.parseTagDEMO;this.parseTag.VR=this.parseTagVR;this.parseTag.ANAGLYPH=this.parseTagANAGLYPH;this.parseTag.STEREO=this.parseTagSTEREO;this.parseTag.PERSPECTIVE=this.parseTagPERSPECTIVE;this.parseTag.ORTHOGRAPHIC=this.parseTagORTHOGRAPHIC;this.parseTag.BACKGROUND=this.parseTagBACKGROUND;this.parseTag.ONTIME=this.parseTagONTIME;this.parseTag.POINT=this.parseTagPOINT;this.parseTag.LINE=this.parseTagLINE;this.parseTag.SQUARE=this.parseTagSQUARE;this.parseTag.CUBE=this.parseTagCUBE;this.parseTag.CIRCLE=this.parseTagCIRCLE;this.parseTag.POLYGON=this.parseTagPOLYGON;this.parseTag.SPHERE=this.parseTagSPHERE;this.parseTag.CYLINDER=this.parseTagCYLINDER;this.parseTag.PRISM=this.parseTagPRISM;this.parseTag.CONE=this.parseTagCONE;this.parseTag.PYRAMID=this.parseTagPYRAMID;this.parseTag.BUTTON=this.skipTag;this.parseTag.CANVAS=this.skipTagSilently;this.parseTag.DIV=this.skipTag;this.parseTag.SPAN=this.skipTag;}
parseTags()
{this.suica.debugCall('parseTags');this.suica.parser=null;this.suica.parserReadonly=this;this.parseTagsInElement(this.suica,this.suica.suicaTag);this.suica.render();}
parseTagsInElement(that,elem)
{for(var i=0;i<elem.children.length;i++)
{var tagName=elem.children[i].tagName;if(this.parseTag[tagName])
this.parseTag[tagName](this.suica,elem.children[i]);else
console.error(`error: unknown tag <${tagName}> in <${that.tagName}>`);this.parseTagsInElement(this.suica,elem.children[i]);}}
skipTag(suica,elem)
{suica.debugCall('skipTag',elem.tagName);}
skipTagSilently(suica,elem)
{}
parseTagOXYZ(suica,elem)
{suica.oxyz(elem.getAttribute('size')||Suica.DEFAULT.OXYZ.SIZE,elem.getAttribute('color')||Suica.DEFAULT.OXYZ.COLOR);}
parseTagDEMO(suica,elem)
{suica.demo(elem.getAttribute('distance')||Suica.DEFAULT.DEMO.DISTANCE,elem.getAttribute('altitude')||Suica.DEFAULT.DEMO.ALTITUDE);}
parseTagVR(suica,elem)
{suica.vr();}
parseTagANAGLYPH(suica,elem)
{suica.anaglyph(elem.getAttribute('distance')||Suica.DEFAULT.ANAGLYPH.DISTANCE);}
parseTagSTEREO(suica,elem)
{suica.stereo(elem.getAttribute('distance')||Suica.DEFAULT.STEREO.DISTANCE);}
parseTagPERSPECTIVE(suica,elem)
{suica.perspective(elem.getAttribute('near')||Suica.DEFAULT.PERSPECTIVE.NEAR,elem.getAttribute('far')||Suica.DEFAULT.PERSPECTIVE.FAR,elem.getAttribute('fov')||Suica.DEFAULT.PERSPECTIVE.FOV);}
parseTagORTHOGRAPHIC(suica,elem)
{suica.perspective(elem.getAttribute('near')||Suica.DEFAULT.ORTHOGRAPHIC.NEAR,elem.getAttribute('far')||Suica.DEFAULT.ORTHOGRAPHIC.FAR);}
parseTagBACKGROUND(suica,elem)
{suica.background(elem.getAttribute('color')||Suica.DEFAULT.BACKGROUND.COLOR);}
parseTagONTIME(suica,elem)
{suica.onTime(elem.getAttribute('src')||Suica.DEFAULT.ONTIME.SRC);}
parseAttributes(elem,object,widthHeight,depth,wireframe)
{if(elem.hasAttribute('x'))object.x=Number(elem.getAttribute('x'));if(elem.hasAttribute('y'))object.y=Number(elem.getAttribute('y'));if(elem.hasAttribute('z'))object.z=Number(elem.getAttribute('z'));if(widthHeight)
{if(elem.hasAttribute('width'))object.width=Number(elem.getAttribute('width'));if(elem.hasAttribute('height'))object.height=Number(elem.getAttribute('height'));}
if(depth)
{if(elem.hasAttribute('depth'))object.depth=Number(elem.getAttribute('depth'));}
if(wireframe)
{if(elem.hasAttribute('wireframe'))object.wireframe=['','true','yes','1'].indexOf(elem.getAttribute('wireframe').toLowerCase())>=0;}
var id=elem.getAttribute('id');if(id)window[id]=object;}
parseTagPOINT(suica,elem)
{var p=suica.point(elem.getAttribute('center')||Suica.DEFAULT.POINT.CENTER,elem.getAttribute('size')||Suica.DEFAULT.POINT.SIZE,elem.getAttribute('color')||Suica.DEFAULT.POINT.COLOR);suica.parserReadonly.parseAttributes(elem,p);elem.suicaObject=p;}
parseTagLINE(suica,elem)
{var p=suica.line(elem.getAttribute('center')||elem.getAttribute('from')||Suica.DEFAULT.LINE.CENTER,elem.getAttribute('to')||Suica.DEFAULT.LINE.TO,elem.getAttribute('color')||Suica.DEFAULT.LINE.COLOR);var id=elem.getAttribute('id');if(id)window[id]=p;elem.suicaObject=p;}
parseTagSQUARE(suica,elem)
{var p=suica.square(elem.getAttribute('center')||Suica.DEFAULT.SQUARE.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.SQUARE.SIZE),elem.getAttribute('color')||Suica.DEFAULT.SQUARE.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,false,true);elem.suicaObject=p;}
parseTagCUBE(suica,elem)
{var p=suica.cube(elem.getAttribute('center')||Suica.DEFAULT.CUBE.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.CUBE.SIZE),elem.getAttribute('color')||Suica.DEFAULT.CUBE.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,true,true);elem.suicaObject=p;}
parseTagCIRCLE(suica,elem)
{var p=suica.circle(elem.getAttribute('center')||Suica.DEFAULT.CIRCLE.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.CIRCLE.SIZE),elem.getAttribute('color')||Suica.DEFAULT.CIRCLE.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,false,true);elem.suicaObject=p;}
parseTagPOLYGON(suica,elem)
{var p=suica.polygon(elem.getAttribute('count')||Suica.DEFAULT.POLYGON.COUNT,elem.getAttribute('center')||Suica.DEFAULT.POLYGON.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.POLYGON.SIZE),elem.getAttribute('color')||Suica.DEFAULT.POLYGON.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,false,true);elem.suicaObject=p;}
parseTagSPHERE(suica,elem)
{var p=suica.sphere(elem.getAttribute('center')||Suica.DEFAULT.SPHERE.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.SPHERE.SIZE),elem.getAttribute('color')||Suica.DEFAULT.SPHERE.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,true);elem.suicaObject=p;}
parseTagCYLINDER(suica,elem)
{var p=suica.cylinder(elem.getAttribute('center')||Suica.DEFAULT.CYLINDER.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.CYLINDER.SIZE),elem.getAttribute('color')||Suica.DEFAULT.CYLINDER.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,true);elem.suicaObject=p;}
parseTagPRISM(suica,elem)
{var p=suica.prism(elem.getAttribute('count')||Suica.DEFAULT.PRISM.COUNT,elem.getAttribute('center')||Suica.DEFAULT.PRISM.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.PRISM.SIZE),elem.getAttribute('color')||Suica.DEFAULT.PRISM.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,true,true);elem.suicaObject=p;}
parseTagCONE(suica,elem)
{var p=suica.cone(elem.getAttribute('center')||Suica.DEFAULT.CONE.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.CONE.SIZE),elem.getAttribute('color')||Suica.DEFAULT.CONE.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,true);elem.suicaObject=p;}
parseTagPYRAMID(suica,elem)
{var p=suica.pyramid(elem.getAttribute('count')||Suica.DEFAULT.PYRAMID.COUNT,elem.getAttribute('center')||Suica.DEFAULT.PYRAMID.CENTER,Suica.parseSize(elem.getAttribute('size')||Suica.DEFAULT.PYRAMID.SIZE),elem.getAttribute('color')||Suica.DEFAULT.PYRAMID.COLOR);suica.parserReadonly.parseAttributes(elem,p,true,true,true);elem.suicaObject=p;}}
class Drawing
{static current;constructor(width=32,height=width,color=null)
{this.canvas=document.createElement('canvas');this.canvas.width=width;this.canvas.height=height;this.texture=null;this.context=this.canvas.getContext('2d');this.context.clearRect(0,0,width,height);if(color)
{this.context.fillStyle=color;this.context.fillRect(0,0,width,height);}
this.context.beginPath();}
moveTo(x=0,y=0)
{this.context.moveTo(x,this.canvas.height-y);}
lineTo(x=0,y=0)
{this.context.lineTo(x,this.canvas.height-y);}
curveTo(mx=0,my=0,x=0,y=0)
{this.context.quadraticCurveTo(mx,this.canvas.height-my,x,this.canvas.height-y);}
arc(x=0,y=0,r=10,from=0,to=360)
{this.context.arc(x,this.canvas.height-y,r,from*Math.PI/2,to*Math.PI/2);}
fillText(x=0,y=0,text='',color='black',font='20px Arial')
{this.context.fillStyle=color;this.context.font=font;this.context.fillText(text,x,this.canvas.height-y);}
stroke(color='black',width=1)
{this.texture=null;this.context.strokeStyle=color;this.context.lineWidth=width;this.context.stroke();this.context.beginPath();}
fill(color='gray')
{this.texture=null;this.context.fillStyle=color;this.context.fill();this.context.beginPath();}
fillAndStroke(fillColor='gray',strokeColor='black',width=1)
{this.texture=null;this.context.strokeStyle=strokeColor;this.context.lineWidth=width;this.context.stroke();this.context.fillStyle=fillColor;this.context.fill();this.context.beginPath();}
get image()
{if(!this.texture)
this.texture=new THREE.CanvasTexture(this.canvas);return this.texture;}
static precheck()
{if(!(Drawing.current instanceof Drawing))
throw'error: No Drawing instance is active';}}
window.drawing=function(width=32,height=width,color=null)
{Drawing.current=new Drawing(width,height,color);return Drawing.current;}
window.moveTo=function(x=0,y=0)
{Drawing.precheck();Drawing.current.moveTo(x,y);}
window.lineTo=function(x=0,y=0)
{Drawing.precheck();Drawing.current.lineTo(x,y);}
window.curveTo=function(mx=0,my=0,x=0,y=0)
{Drawing.precheck();Drawing.current.curveTo(mx,my,x,y);}
window.arc=function(x=0,y=0,r=10,from=0,to=360)
{Drawing.precheck();Drawing.current.arc(x,y,r,from,to);}
window.fillText=function(x=0,y=0,text='',color='black',font='20px Arial')
{Drawing.precheck();Drawing.current.fillText(x,y,text,color,font);}
window.stroke=function(color='black',width=1)
{Drawing.precheck();Drawing.current.stroke(color,width);}
window.fill=function(color='gray')
{Drawing.precheck();Drawing.current.fill(color);}
window.fillAndStroke=function(fillColor='gray',strokeColor='black',width=1)
{Drawing.precheck();Drawing.current.fillAndStroke(fillColor,strokeColor,width);}
window.image=function(url=null,repeatX=1,repeatY=1)
{Drawing.current=new THREE.TextureLoader().load(url);Drawing.current.wrapS=THREE.RepeatWrapping;Drawing.current.wrapT=THREE.RepeatWrapping;Drawing.current.magFilter=THREE.LinearFilter;Drawing.current.minFilter=THREE.LinearMipmapLinearFilter;Drawing.current.anisotropy=16;Drawing.current.repeat.set(repeatX,repeatY);return Drawing.current;}
﻿
class Mesh
{constructor(suica,solidMesh,frameMesh)
{this.suica=suica;this.solidMesh=solidMesh;this.frameMesh=frameMesh;this.threejs=solidMesh;this.isWireframe=false;this.meshSize=[null,null,null];suica.scene.add(solidMesh);}
static createMaterials()
{var CANVAS_SIZE=128;var canvas=document.createElement('canvas');canvas.width=CANVAS_SIZE;canvas.height=CANVAS_SIZE;var context=canvas.getContext('2d');context.fillStyle='white';var gradient=context.createRadialGradient(CANVAS_SIZE/2,CANVAS_SIZE/2,CANVAS_SIZE/2-5,CANVAS_SIZE/2,CANVAS_SIZE/2,CANVAS_SIZE/2);gradient.addColorStop(0,'white');gradient.addColorStop(1,'rgba(0,0,0,0)');context.fillStyle=gradient;context.beginPath();context.arc(CANVAS_SIZE/2,CANVAS_SIZE/2,CANVAS_SIZE/2-2,0,2*Math.PI);context.fill();Mesh.pointMaterial=new THREE.PointsMaterial({color:'white',size:5,sizeAttenuation:true,map:new THREE.CanvasTexture(canvas),transparent:true,alphaTest:0.5,});Mesh.solidMaterial=new THREE.MeshStandardMaterial({color:'cornflowerblue',side:THREE.DoubleSide,});Mesh.flatMaterial=new THREE.MeshStandardMaterial({color:'cornflowerblue',side:THREE.DoubleSide,flatShading:true,});CANVAS_SIZE=4;var canvas2=document.createElement('canvas');canvas2.width=CANVAS_SIZE;canvas2.height=1;var context2=canvas2.getContext('2d');context2.fillStyle='white';context2.fillRect(0,0,canvas2.width,canvas2.height);Mesh.lineMaterial=new THREE.MeshBasicMaterial({color:'black',transparent:true,map:new THREE.CanvasTexture(canvas2),});Mesh.lineMaterial.onBeforeCompile=shader=>{shader.fragmentShader=shader.fragmentShader.replace('#include <map_fragment>',`#ifdef USE_MAP
     vec4 texelColor = texture2D( map, vUv );
     diffuseColor *= texelColor;
    #endif`);}}
get center()
{this.suica.parser?.parseTags();return[this.threejs.position.x,this.threejs.position.y,this.threejs.position.z];}
set center(center)
{this.suica.parser?.parseTags();center=Suica.parseCenter(center);this.threejs.position.set(center[0],center[1],center[2]);}
get x()
{this.suica.parser?.parseTags();return this.threejs.position.x;}
set x(x)
{this.suica.parser?.parseTags();this.threejs.position.x=x;}
get y()
{this.suica.parser?.parseTags();return this.threejs.position.y;}
set y(y)
{this.suica.parser?.parseTags();this.threejs.position.y=y;}
get z()
{this.suica.parser?.parseTags();return this.threejs.position.z;}
set z(z)
{this.suica.parser?.parseTags();this.threejs.position.z=z;}
get color()
{this.suica.parser?.parseTags();var col=this.threejs.material.color;return[col.r,col.g,col.b];}
set color(col)
{this.suica.parser?.parseTags();this.threejs.material.color=Suica.parseColor(col);this.threejs.material.needsUpdate=true;}
get image()
{return this.threejs.material.map;}
set image(drawing)
{this.suica.parser?.parseTags();if(!drawing)
{delete this.threejs.material.map;this.threejs.material.transparent=false,this.threejs.material.needsUpdate=true;return;}
if(drawing instanceof Drawing)
{this.threejs.material.map=drawing.image;this.threejs.material.transparent=true,this.threejs.material.needsUpdate=true;return;}
if(drawing instanceof THREE.Texture)
{this.threejs.material.map=drawing;this.threejs.material.transparent=true,this.threejs.material.needsUpdate=true;return;}
throw'error: Parameter of `image` is not a drawing';}
updateScale()
{var width=this.meshSize[0];var height=this.meshSize[1];var depth=this.meshSize[2];if(height===null)height=width;if(depth===null)depth=width;switch(this.suica.orientation)
{case Suica.ORIENTATIONS.YXZ:this.threejs.scale.set(height,width,depth);break;case Suica.ORIENTATIONS.ZYX:this.threejs.scale.set(depth,height,width);break;case Suica.ORIENTATIONS.XZY:this.threejs.scale.set(width,depth,height);break;case Suica.ORIENTATIONS.ZXY:this.threejs.scale.set(height,depth,width);break;case Suica.ORIENTATIONS.XYZ:this.threejs.scale.set(width,height,depth);break;case Suica.ORIENTATIONS.YZX:this.threejs.scale.set(depth,width,height);break;default:throw'error: unknown orientation';}}
get width()
{return this.meshSize[0];}
set width(width)
{this.meshSize[0]=width;this.updateScale();}
get height()
{return(this.meshSize[1]!==null)?this.meshSize[1]:this.meshSize[0];}
set height(height)
{this.meshSize[1]=height;this.updateScale();}
get depth()
{return(this.meshSize[2]!==null)?this.meshSize[2]:this.meshSize[0];}
set depth(depth)
{this.meshSize[2]=depth;this.updateScale();}
get size()
{this.suica.parser?.parseTags();if(this.meshSize[2]===null)
{if(this.meshSize[1]===null)
return this.meshSize[0];else
return[this.meshSize[0],this.meshSize[1]];}
return[this.meshSize[0],this.meshSize[1],this.meshSize[2]];}
set size(size)
{this.suica.parser?.parseTags();if(Array.isArray(size))
{if(size.length==0)
this.meshSize=[null,null,null];else
if(size.length==1)
this.meshSize=[size[0],null,null];else
if(size.length==2)
this.meshSize=[size[0],size[1],null];else
this.meshSize=[size[0],size[1],size[2]];}
else
{this.meshSize=[size,null,null];}
this.updateScale();}
get wireframe()
{return this.isWireframe;}
set wireframe(wireframe)
{if(!this.frameMesh)
throw'error: wireframe property not available';this.isWireframe=wireframe;var oldMesh=this.threejs,newMesh=(wireframe===true)||(['','true','yes','1'].indexOf(String(wireframe).toLowerCase())>=0)?this.frameMesh:this.solidMesh;newMesh.position.copy(oldMesh.position);newMesh.scale.copy(oldMesh.scale);newMesh.material.color.copy(oldMesh.material.color);if(oldMesh.material.map)
{newMesh.material.map=oldMesh.material.map;newMesh.material.transparent=oldMesh.material.transparent;newMesh.material.needsUpdate=true;}
this.threejs=newMesh;this.suica.scene.remove(oldMesh);this.suica.scene.add(newMesh);}
style(properties)
{for(var n in properties)this[n]=properties[n];return this;}}
Mesh.createMaterials();﻿
class Point extends Mesh
{static solidGeometry=new THREE.BufferGeometry().setAttribute('position',new THREE.BufferAttribute(new Float32Array([0,0,0]),3));constructor(suica,center,size,color)
{suica.parser?.parseTags();suica.debugCall('point',center,size,color);super(suica,new THREE.Points(Point.solidGeometry,Mesh.pointMaterial.clone()),null,);this.center=center;this.color=color;this.size=size;}
get size()
{this.suica.parser?.parseTags();return this.threejs.material.size;}
set size(size)
{this.suica.parser?.parseTags();this.threejs.material.size=size;this.threejs.material.needsUpdate=true;}
get clone()
{var object=new Point(this.suica,this.center,this.size,this.color);object.image=this.image;return object;}}
window.point=function(center=Suica.DEFAULT.POINT.CENTER,size=Suica.DEFAULT.POINT.SIZE,color=Suica.DEFAULT.POINT.COLOR)
{Suica.precheck();return Suica.current.point(center,size,color);}﻿
class Line extends Mesh
{static solidGeometry=new THREE.BufferGeometry();static
{this.solidGeometry.setAttribute('position',new THREE.BufferAttribute(new Float32Array([0,0,0,0,30,0]),3));this.solidGeometry.setAttribute('uv',new THREE.BufferAttribute(new Float32Array([0,0,1,0]),2));}
constructor(suica,center,to,color)
{suica.parser?.parseTags();suica.debugCall('line',center,to,color);super(suica,new THREE.LineSegments(Line.solidGeometry.clone(),Mesh.lineMaterial.clone()),null,);this.center=center;this.color=color;this.to=to;}
get center()
{this.suica.parser?.parseTags();var pos=this.threejs.geometry.getAttribute('position');return[pos.getX(0),pos.getY(0),pos.getZ(0)];}
set center(center)
{this.suica.parser?.parseTags();center=Suica.parseCenter(center);this.threejs.geometry.getAttribute('position').setXYZ(0,center[0],center[1],center[2]);this.threejs.geometry.needsUpdate=true;}
get from()
{return this.center;}
set from(from)
{this.center=from;}
get to()
{this.suica.parser?.parseTags();var pos=this.threejs.geometry.getAttribute('position');return[pos.getX(1),pos.getY(1),pos.getZ(1)];}
set to(to)
{this.suica.parser?.parseTags();to=Suica.parseCenter(to);this.threejs.geometry.getAttribute('position').setXYZ(1,to[0],to[1],to[2]);this.threejs.geometry.needsUpdate=true;}
get size()
{throw'error: size is not available for line';}
set size(size)
{throw'error: size is not available for line';}
get width()
{throw'error: width is not available for line';}
set width(width)
{throw'error: width is not available for line';}
get height()
{throw'error: height is not available for line';}
set height(height)
{throw'error: height is not available for line';}
get depth()
{throw'error: depth is not available for line';}
set depth(depth)
{throw'error: depth is not available for line';}
get x()
{throw'error: x is not available for line';}
set x(x)
{throw'error: x is not available for line';}
get y()
{throw'error: y is not available for line';}
set y(y)
{throw'error: y is not available for line';}
get z()
{throw'error: z is not available for line';}
set z(z)
{throw'error: z is not available for line';}
get clone()
{var object=new Line(this.suica,this.from,this.to,this.color);object.image=this.image;return object;}}
window.line=function(center=Suica.DEFAULT.LINE.CENTER,to=Suica.DEFAULT.LINE.TO,color=Suica.DEFAULT.LINE.COLOR)
{Suica.precheck();return Suica.current.line(center,to,color);}﻿
class Square extends Mesh
{constructor(suica,center,size,color)
{suica.parser?.parseTags();suica.debugCall('square',center,size,color);suica._.solidGeometry.square=suica.flipNormal(new THREE.PlaneGeometry(1,1).applyMatrix4(suica.orientation.MATRIX));;suica._.frameGeometry.square=new THREE.BufferGeometry();suica._.frameGeometry.square.setAttribute('position',new THREE.BufferAttribute(new Float32Array([-0.5,-0.5,0,+0.5,-0.5,0,+0.5,-0.5,0,+0.5,+0.5,0,+0.5,+0.5,0,-0.5,+0.5,0,-0.5,+0.5,0,-0.5,-0.5,0,]),3));suica._.frameGeometry.square.setAttribute('uv',new THREE.BufferAttribute(new Float32Array([0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,]),2));suica._.frameGeometry.square.applyMatrix4(suica.orientation.MATRIX);super(suica,new THREE.Mesh(suica._.solidGeometry.square,Mesh.solidMaterial.clone()),new THREE.LineSegments(suica._.frameGeometry.square,Mesh.lineMaterial.clone()),);this.center=center;this.color=color;this.size=size;}
get clone()
{var object=new Square(this.suica,this.center,this.size,this.color);object.wireframe=this.wireframe;object.image=this.image;return object;}}
window.square=function(center=Suica.DEFAULT.SQUARE.CENTER,size=Suica.DEFAULT.SQUARE.SIZE,color=Suica.DEFAULT.SQUARE.COLOR)
{Suica.precheck();return Suica.current.square(center,size,color);}
﻿
class Cube extends Mesh
{constructor(suica,center,size,color)
{suica.parser?.parseTags();suica.debugCall('cube',center,size,color);suica._.solidGeometry.cube=suica.flipNormal(new THREE.BoxGeometry(1,1,1).applyMatrix4(suica.orientation.MATRIX));suica._.frameGeometry.cube=new THREE.BufferGeometry();suica._.frameGeometry.cube.setAttribute('position',new THREE.BufferAttribute(new Float32Array([-0.5,-0.5,-0.5,+0.5,-0.5,-0.5,+0.5,-0.5,-0.5,+0.5,+0.5,-0.5,+0.5,+0.5,-0.5,-0.5,+0.5,-0.5,-0.5,+0.5,-0.5,-0.5,-0.5,-0.5,-0.5,-0.5,+0.5,+0.5,-0.5,+0.5,+0.5,-0.5,+0.5,+0.5,+0.5,+0.5,+0.5,+0.5,+0.5,-0.5,+0.5,+0.5,-0.5,+0.5,+0.5,-0.5,-0.5,+0.5,-0.5,-0.5,-0.5,-0.5,-0.5,+0.5,+0.5,-0.5,-0.5,+0.5,-0.5,+0.5,+0.5,+0.5,-0.5,+0.5,+0.5,+0.5,-0.5,+0.5,-0.5,-0.5,+0.5,+0.5,]),3));suica._.frameGeometry.cube.setAttribute('uv',new THREE.BufferAttribute(new Float32Array([0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,]),2));suica._.frameGeometry.cube=suica._.frameGeometry.cube.applyMatrix4(suica.orientation.MATRIX);super(suica,new THREE.Mesh(suica._.solidGeometry.cube,Mesh.solidMaterial.clone()),new THREE.LineSegments(suica._.frameGeometry.cube,Mesh.lineMaterial.clone()),);this.center=center;this.color=color;this.size=size;}
get clone()
{var object=new Cube(this.suica,this.center,this.size,this.color);object.wireframe=this.wireframe;object.image=this.image;return object;}}
window.cube=function(center=Suica.DEFAULT.CUBE.CENTER,size=Suica.DEFAULT.CUBE.SIZE,color=Suica.DEFAULT.CUBE.COLOR)
{Suica.precheck();return Suica.current.cube(center,size,color);}
﻿
class Polygon extends Mesh
{constructor(suica,count,center,size,color)
{suica.parser?.parseTags();if(count<Suica.DEFAULT.CIRCLE.COUNT)
suica.debugCall('polygon',count,center,size,color);else
suica.debugCall('circle',center,size,color);suica._.solidGeometry.polygon=[];suica._.frameGeometry.polygon=[];super(suica,new THREE.Mesh(Polygon.getSolidGeometry(suica,count),Mesh.solidMaterial.clone()),new THREE.LineLoop(Polygon.getFrameGeometry(suica,count),Mesh.lineMaterial.clone()),);this.center=center;this.color=color;this.size=size;this.n=count;}
get count()
{this.suica.parser?.parseTags();return this.n;}
set count(count)
{this.suica.parser?.parseTags();if(count==this.n)return;this.solidMesh.geometry=Polygon.getSolidGeometry(count);this.frameMesh.geometry=Polygon.getFrameGeometry(count);this.threejs.geometry=this.isWireframe?this.frameMesh.geometry:this.solidMesh.geometry;}
static getSolidGeometry(suica,count)
{if(!suica._.solidGeometry.polygon[count])
suica._.solidGeometry.polygon[count]=suica.flipNormal(new THREE.CircleGeometry(0.5,count,-Math.PI*(1/2-1/count)).applyMatrix4(suica.orientation.MATRIX));return suica._.solidGeometry.polygon[count];}
static getFrameGeometry(suica,count)
{if(!suica._.frameGeometry.polygon[count])
{suica._.frameGeometry.polygon[count]=new THREE.BufferGeometry();let vertices=new Float32Array(3*count+3),uvs=new Float32Array(2*count+2);for(var i=0;i<=count;i++)
{var angle=2*Math.PI*i/count-Math.PI*(1/2-1/count);vertices[3*i]=0.5*Math.cos(angle);vertices[3*i+1]=0.5*Math.sin(angle);if(count>8)
uvs[2*i]=4*i/count;else
uvs[2*i]=i;}
suica._.frameGeometry.polygon[count].setAttribute('position',new THREE.BufferAttribute(vertices,3));suica._.frameGeometry.polygon[count].setAttribute('uv',new THREE.BufferAttribute(uvs,2));suica._.frameGeometry.polygon[count].applyMatrix4(suica.orientation.MATRIX);}
return suica._.frameGeometry.polygon[count];}
get clone()
{var object=new Polygon(this.suica,this.n,this.center,this.size,this.color);object.wireframe=this.wireframe;object.image=this.image;return object;}}
window.circle=function(center=Suica.DEFAULT.CIRCLE.CENTER,size=Suica.DEFAULT.CIRCLE.SIZE,color=Suica.DEFAULT.CIRCLE.COLOR)
{Suica.precheck();return Suica.current.circle(center,size,color);}
window.polygon=function(count=Suica.DEFAULT.POLYGON.COUNT,center=Suica.DEFAULT.POLYGON.CENTER,size=Suica.DEFAULT.POLYGON.SIZE,color=Suica.DEFAULT.POLYGON.COLOR)
{Suica.precheck();return Suica.current.polygon(count,center,size,color);}﻿
class Sphere extends Mesh
{constructor(suica,center,size,color)
{suica.parser?.parseTags();suica.debugCall('sphere',center,size,color);suica._.solidGeometry.sphere=null;if(!suica._.solidGeometry.sphere)
{suica._.solidGeometry.sphere=suica.flipNormal(new THREE.SphereGeometry(0.5,Suica.DEFAULT.SPHERE.COUNT,Math.round(Suica.DEFAULT.SPHERE.COUNT/2)).applyMatrix4(suica.orientation.MATRIX));}
super(suica,new THREE.Mesh(suica._.solidGeometry.sphere,Mesh.solidMaterial.clone()),null,);this.center=center;this.color=color;this.size=size;}
get clone()
{var object=new Sphere(this.suica,this.center,this.size,this.color);object.image=this.image;return object;}}
window.sphere=function(center=Suica.DEFAULT.SPHERE.CENTER,size=Suica.DEFAULT.SPHERE.SIZE,color=Suica.DEFAULT.SPHERE.COLOR)
{Suica.precheck();return Suica.current.sphere(center,size,color);}
﻿
class Prism extends Mesh
{constructor(suica,count,center,size,color,flatShading)
{suica.parser?.parseTags();if(flatShading)
suica.debugCall('prism',count,center,size,color);else
suica.debugCall('cylinder',center,size,color);suica._.solidGeometry.prism=[];suica._.frameGeometry.prism=[];super(suica,new THREE.Mesh(Prism.getSolidGeometry(suica,count),flatShading?Mesh.flatMaterial.clone():Mesh.solidMaterial.clone()),new THREE.LineSegments(Prism.getFrameGeometry(suica,count),Mesh.lineMaterial.clone()),);this.center=center;this.color=color;this.size=size;this.n=count;this.flatShading=flatShading;}
get count()
{this.suica.parser?.parseTags();return this.n;}
set count(count)
{this.suica.parser?.parseTags();if(count==this.n)return;this.solidMesh.geometry=Prism.getSolidGeometry(count);this.frameMesh.geometry=Prism.getFrameGeometry(count);this.threejs.geometry=this.isWireframe?this.frameMesh.geometry:this.solidMesh.geometry;}
static getSolidGeometry(suica,count)
{if(!suica._.solidGeometry.prism[count])
suica._.solidGeometry.prism[count]=suica.flipNormal(new THREE.CylinderGeometry(0.5,0.5,1,count,1,false).translate(0,0.5,0).applyMatrix4(suica.orientation.MATRIX));return suica._.solidGeometry.prism[count];}
static getFrameGeometry(suica,count)
{if(!suica._.frameGeometry.prism[count])
{suica._.frameGeometry.prism[count]=new THREE.BufferGeometry();let vertices=new Float32Array(3*2*3*count),uvs=new Float32Array(2*2*3*count);for(var i=0;i<count;i++)
{var angle1=2*Math.PI*i/count-Math.PI*(1/2-1/count),sin1=0.5*Math.sin(angle1),cos1=0.5*Math.cos(angle1);var angle2=2*Math.PI*(i+1)/count-Math.PI*(1/2-1/count),sin2=0.5*Math.sin(angle2),cos2=0.5*Math.cos(angle2);vertices[18*i]=cos1;vertices[18*i+1]=0;vertices[18*i+2]=sin1;vertices[18*i+3]=cos2;vertices[18*i+4]=0;vertices[18*i+5]=sin2;vertices[18*i+6]=cos1;vertices[18*i+7]=1;vertices[18*i+8]=sin1;vertices[18*i+9]=cos2;vertices[18*i+10]=1;vertices[18*i+11]=sin2;vertices[18*i+12]=cos1;vertices[18*i+13]=0;vertices[18*i+14]=sin1;vertices[18*i+15]=cos1;vertices[18*i+16]=1;vertices[18*i+17]=sin1;console.assert(uvs[2*i+1]==0);var u1,u2;if(count>8)
{u1=4*i/count;u2=4*(i+1)/count;}
else
{u1=i;u2=i+1;}
uvs[12*i]=u1;uvs[12*i+2]=u2;uvs[12*i+4]=u1;uvs[12*i+6]=u2;uvs[12*i+8]=0;uvs[12*i+10]=1;}
suica._.frameGeometry.prism[count].setAttribute('position',new THREE.BufferAttribute(vertices,3));suica._.frameGeometry.prism[count].setAttribute('uv',new THREE.BufferAttribute(uvs,2));suica._.frameGeometry.prism[count].applyMatrix4(suica.orientation.MATRIX);}
return suica._.frameGeometry.prism[count];}
get clone()
{var object=new Prism(this.suica,this.n,this.center,this.size,this.color,this.flatShading);object.wireframe=this.wireframe;object.image=this.image;return object;}}
window.cylinder=function(center=Suica.DEFAULT.CYLINDER.CENTER,size=Suica.DEFAULT.CYLINDER.SIZE,color=Suica.DEFAULT.CYLINDER.COLOR)
{Suica.precheck();return Suica.current.cylnder(center,size,color);}
window.prism=function(count=Suica.DEFAULT.PRISM.COUNT,center=Suica.DEFAULT.PRISM.CENTER,size=Suica.DEFAULT.PRISM.SIZE,color=Suica.DEFAULT.PRISM.COLOR)
{Suica.precheck();return Suica.current.prism(count,center,size,color);}﻿
class Pyramid extends Mesh
{constructor(suica,count,center,size,color,flatShading)
{suica.parser?.parseTags();if(flatShading)
suica.debugCall('pyramid',count,center,size,color);else
suica.debugCall('cone',center,size,color);suica._.solidGeometry.pyramid=[];suica._.frameGeometry.pyramid=[];super(suica,new THREE.Mesh(Pyramid.getSolidGeometry(suica,count),flatShading?Mesh.flatMaterial.clone():Mesh.solidMaterial.clone()),new THREE.LineSegments(Pyramid.getFrameGeometry(suica,count),Mesh.lineMaterial.clone()),);this.center=center;this.color=color;this.size=size;this.n=count;this.flatShading=flatShading;}
get count()
{this.suica.parser?.parseTags();return this.n;}
set count(count)
{this.suica.parser?.parseTags();if(count==this.n)return;this.solidMesh.geometry=Pyramid.getSolidGeometry(this.suica,count);this.frameMesh.geometry=Pyramid.getFrameGeometry(this.suica,count);this.threejs.geometry=this.isWireframe?this.frameMesh.geometry:this.solidMesh.geometry;}
static getSolidGeometry(suica,count)
{if(!suica._.solidGeometry.pyramid[count])
{suica._.solidGeometry.pyramid[count]=suica.flipNormal(new THREE.ConeGeometry(0.5,1,count,1,false).translate(0,0.5,0).applyMatrix4(suica.orientation.MATRIX));}
return suica._.solidGeometry.pyramid[count];}
static getFrameGeometry(suica,count)
{if(!suica._.frameGeometry.pyramid[count])
{suica._.frameGeometry.pyramid[count]=new THREE.BufferGeometry();let vertices=new Float32Array(3*2*2*count),uvs=new Float32Array(2*2*2*count);for(var i=0;i<count;i++)
{var angle1=2*Math.PI*i/count-Math.PI*(1/2-1/count),sin1=0.5*Math.sin(angle1),cos1=0.5*Math.cos(angle1);var angle2=2*Math.PI*(i+1)/count-Math.PI*(1/2-1/count),sin2=0.5*Math.sin(angle2),cos2=0.5*Math.cos(angle2);vertices[12*i]=cos1;vertices[12*i+1]=0;vertices[12*i+2]=sin1;vertices[12*i+3]=cos2;vertices[12*i+4]=0;vertices[12*i+5]=sin2;vertices[12*i+6]=cos1;vertices[12*i+7]=0;vertices[12*i+8]=sin1;vertices[12*i+9]=0;vertices[12*i+10]=1;vertices[12*i+11]=0;console.assert(uvs[2*i+1]==0);var u1,u2;if(count>8)
{u1=4*i/count;u2=4*(i+1)/count;}
else
{u1=i;u2=i+1;}
uvs[8*i]=u1;uvs[8*i+2]=u2;uvs[8*i+4]=0;uvs[8*i+6]=1;}
suica._.frameGeometry.pyramid[count].setAttribute('position',new THREE.BufferAttribute(vertices,3));suica._.frameGeometry.pyramid[count].setAttribute('uv',new THREE.BufferAttribute(uvs,2));suica._.frameGeometry.pyramid[count].applyMatrix4(suica.orientation.MATRIX);}
return suica._.frameGeometry.pyramid[count];}
get clone()
{var object=new Pyramid(this.suica,this.n,this.center,this.size,this.color,this.flatShading);object.wireframe=this.wireframe;object.image=this.image;return object;}}
window.cone=function(center=Suica.DEFAULT.CONE.CENTER,size=Suica.DEFAULT.CONE.SIZE,color=Suica.DEFAULT.CONE.COLOR)
{Suica.precheck();return Suica.current.cone(center,size,color);}
window.pyramid=function(count=Suica.DEFAULT.PYRAMID.COUNT,center=Suica.DEFAULT.PYRAMID.CENTER,size=Suica.DEFAULT.PYRAMID.SIZE,color=Suica.DEFAULT.PYRAMID.COLOR)
{Suica.precheck();return Suica.current.pyramid(count,center,size,color);}}